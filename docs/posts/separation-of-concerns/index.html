<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Showcase how tu use dependency injection to avoid mixing concerns">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="generator" content="Eleventy v2.0.1">
    <title>lorenzofox blog | How to avoid mixing business and technical concerns</title>
    <link rel="icon" href="/public/favicon.ico"/>
    <link rel="stylesheet" href="/public/theme.css">
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Blog"/>
    <style>
        #logo {
            aspect-ratio: 1 / 1;
            width: 128px;
        }

        #sprite {
            display: none;
        }
    </style>
</head>
<body>
<svg id="sprite" aria-hidden="true" class="visually-hidden" xmlns="http://www.w3.org/2000/svg">
    <symbol id="devto">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path>
        </svg>
    </symbol>
    <symbol id="github">
        <svg viewBox="0 0 496 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/>
        </svg>
    </symbol>
    <symbol id="medium">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM144.5 319c-35.1 0-63.5-28.4-63.5-63.5s28.4-63.5 63.5-63.5 63.5 28.4 63.5 63.5-28.4 63.5-63.5 63.5zm159 0c-35.1 0-63.5-28.4-63.5-63.5s28.4-63.5 63.5-63.5 63.5 28.4 63.5 63.5-28.4 63.5-63.5 63.5z"/>
        </svg>
    </symbol>
    <symbol id="linkedin">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </symbol>
    <symbol id="rss">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M384 32H64C28.65 32 0 60.66 0 96v320c0 35.34 28.65 64 64 64h320c35.35 0 64-28.66 64-64V96C448 60.66 419.3 32 384 32zM150.6 374.6C144.4 380.9 136.2 384 128 384s-16.38-3.121-22.63-9.371c-12.5-12.5-12.5-32.76 0-45.26C111.6 323.1 119.8 320 128 320s16.38 3.121 22.63 9.371C163.1 341.9 163.1 362.1 150.6 374.6zM249.6 383.9C249 383.1 248.5 384 247.1 384c-12.53 0-23.09-9.75-23.92-22.44C220.5 306.9 173.1 259.5 118.4 255.9c-13.22-.8438-23.25-12.28-22.39-25.5c.8594-13.25 12.41-22.81 25.52-22.38c77.86 5.062 145.3 72.5 150.4 150.4C272.8 371.7 262.8 383.1 249.6 383.9zM345 383.1C344.7 384 344.3 384 343.1 384c-12.8 0-23.42-10.09-23.97-23C315.6 254.6 225.4 164.4 119 159.1C105.8 159.4 95.47 148.3 96.02 135C96.58 121.8 107.9 111.2 121 112c130.7 5.469 241.5 116.3 246.1 246.1C368.5 372.3 358.3 383.4 345 383.1z"/>
        </svg>
    </symbol>
</svg>

<header id="main-header" >
    <nav aria-label="main navigation" class="wide">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a rel="author" href="/about">About</a></li>
        </ul>
    </nav>
    <div class="heading wide">
        <a aria-label="home" href="/"><img id="logo" src="/public/logo.webp" alt="lorenzofox's blog logo"/></a>
        <div class="title">
            <h1>How to avoid mixing business and technical concerns</h1>
            
            <p class="publication-date">
                First publication date:
                <time datetime="2024-05-23">Thursday, 23 May 2024</time>
            </p>
            
        </div>
    </div>
</header>
<main id="main">
    <div class="intro"> 
<p class="wide">
When implementing business cases, you don't want to have to deal with database transactions, low-level telemetry and other technical details. 
In this series, we will build a small framework around dependency injection to make sure business and technical concerns are separated.  
</p>
</div>
<h2 id="introduction-example" tabindex="-1"><a class="header-anchor" href="#introduction-example">Introduction example</a></h2>
<p>Suppose you have to implement a command that transfers money from one bank account to another. The code can look like
this:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> assert <span class="token keyword">from</span> <span class="token string">'node:assert'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">BankAccount</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    bankAccountId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    balance<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">BankAccountService</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bankAccountId<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> bankAccountId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>BankAccount <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bankAccountId<span class="token punctuation">,</span> balance<span class="token punctuation">}</span><span class="token operator">:</span> BankAccount<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createTransferMoneyCommand</span> <span class="token operator">=</span>
    <span class="token punctuation">(</span><span class="token punctuation">{</span>bankAccountService<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> bankAccountService<span class="token operator">:</span> BankAccountService <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>from<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> from<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> to<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
       
            <span class="token keyword">const</span> <span class="token punctuation">[</span>fromAccount<span class="token punctuation">,</span> toAccount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
                <span class="token punctuation">[</span>from<span class="token punctuation">,</span> to<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bankAccountId<span class="token punctuation">)</span> <span class="token operator">=></span>
                    bankAccountService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bankAccountId<span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>fromAccount<span class="token punctuation">,</span> <span class="token string">'origin account does not exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>toAccount<span class="token punctuation">,</span> <span class="token string">'target account does not exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ... some other business rules</span>

            <span class="token keyword">const</span> newToBalance <span class="token operator">=</span> toAccount<span class="token punctuation">.</span>balance <span class="token operator">+</span> amount<span class="token punctuation">;</span>
            <span class="token keyword">const</span> newFromBalance <span class="token operator">=</span> fromAccount<span class="token punctuation">.</span>balance <span class="token operator">-</span> amount<span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                bankAccountService<span class="token punctuation">.</span><span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    bankAccountId<span class="token operator">:</span> fromAccount<span class="token punctuation">.</span>bankAccountId<span class="token punctuation">,</span>
                    balance<span class="token operator">:</span> newFromBalance
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                bankAccountService<span class="token punctuation">.</span><span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    bankAccountId<span class="token operator">:</span> toAccount<span class="token punctuation">.</span>bankAccountId<span class="token punctuation">,</span>
                    balance<span class="token operator">:</span> newToBalance
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Interestingly, the command does not know anything about its dependencies (<code>bankAccountService</code>). On the contrary, it
<em>exports</em> the contract they must fulfil.<br>
At this point, the <code>bankAccountService</code> could be anything from a stub, to service that talks to a database, to a
component that uses a remote protocol to call third party service.</p>
<p>Let’s see a possible implementation of the <code>bankAccountService</code>:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span>DBClient<span class="token punctuation">,</span> <span class="token constant">SQL</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BankAccount<span class="token punctuation">,</span> BankAccountService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./transfer-money.command'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createBankAccountRepository <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    db<span class="token operator">:</span> DBClient<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> BankAccountService <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bankAccountId<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> bankAccountId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">query</span><span class="token generic class-name"><span class="token operator">&lt;</span>BankAccount<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token constant">SQL</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
SELECT
  bank_account_id as "bankAccountId",
  balance as "balance"
FROM
  bank_accounts
WHERE
  bank_account_id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bankAccountId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rows<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                bankAccountId<span class="token punctuation">,</span>
                                balance
                            <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            bankAccountId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
            balance<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token constant">SQL</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
UPDATE
    bank_accounts
SET
    balance=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
WHERE
    bank_account_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bankAccountId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This is a <em>repository</em> that relies on a low-level client database using SQL as the query language.
This time, the repository imports types from its dependency and makes explicit the command contract it satisfies (this
is not mandatory, as the type checker will throw an error anyway if we don’t pass a proper <code>BankAccountService</code> to the
command factory).
There is no need to be as abstract as in the command: this is already a low-level component, although you could, for
example, swap a Postgres implementation for a MySql implementation.</p>
<p>The database client could be a simple wrapper around <code>node-pg</code> for now:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span>PoolClient<span class="token punctuation">,</span> Pool<span class="token punctuation">,</span> PoolConfig<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pg'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>SQLStatement<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'sql-template-strings'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">DBClient</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token generic-function"><span class="token function">query</span><span class="token generic class-name"><span class="token operator">&lt;</span>Row<span class="token operator">></span></span></span><span class="token punctuation">(</span>statement<span class="token operator">:</span> SQLStatement <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>Row<span class="token operator">>></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> createClient <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> client<span class="token operator">:</span> Pick<span class="token operator">&lt;</span>PoolClient<span class="token punctuation">,</span> <span class="token string">'query'</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">query</span><span class="token punctuation">(</span>query<span class="token operator">:</span> SQLStatement <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>rows<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createDB</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>pgConf<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> pgConf<span class="token operator">:</span> PoolConfig<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span>pgConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>client<span class="token operator">:</span> pool<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h2 id="low-coupling-and-boilerplate" tabindex="-1"><a class="header-anchor" href="#low-coupling-and-boilerplate">Low coupling and boilerplate</a></h2>
<p>The command is not coupled to any particular dependency, yet there is no magic: you need to glue all the pieces
together at some point:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token function-variable function">createBankAccountModule</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>pgConf<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">createDB</span><span class="token punctuation">(</span><span class="token punctuation">{</span>pgConf<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bankAccountService <span class="token operator">=</span> <span class="token function">createBankAccountRepository</span><span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> transferMoney <span class="token operator">=</span> <span class="token function">createTransferMoneyCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bankAccoutSerice<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        transferMoney
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pgConf <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// coming from env etc</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>transferMoney<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createBankAccountModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>pgConf<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">transfertMoney</span><span class="token punctuation">(</span><span class="token punctuation">{</span>from<span class="token operator">:</span> <span class="token string">'account1'</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token string">'account2'</span><span class="token punctuation">,</span> amount<span class="token operator">:</span> <span class="token number">2_000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Even if the sequence of instantiation statements looks daunting, I personally find such a code very insightful:
you have in a single place all the connections between the various components and how they relate to each other.</p>
<h3 id="dependency-injection-container" tabindex="-1"><a class="header-anchor" href="#dependency-injection-container">Dependency Injection container</a></h3>
<p>An alternative is to use a dependency injection container which gives you the ability to explicit all the components in
a declarative way, while losing the explicit relationship between them in the process.</p>
<p>Let’s use <a href="https://github.com/lorenzofox3/dismoi">dismoi</a>(a library I wrote) for this. You define the components as a map whose keys are the injection tokens (usually their names) and whose values are the factory functions to instantiate them.
You can possibly bind the missing dependencies on the late (or override some already provided if needed):</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span>createProvider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dismoi'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> createBankAccounModule <span class="token operator">=</span> <span class="token function">createProvider</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    injectables<span class="token operator">:</span> <span class="token punctuation">{</span>
        transferMoney<span class="token operator">:</span> createTransferMoneyCommand<span class="token punctuation">,</span>
        bankAccountService<span class="token operator">:</span> createBankAccountRepository<span class="token punctuation">,</span>
        db<span class="token operator">:</span> createDB
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    api<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'transferMoney'</span><span class="token punctuation">]</span> <span class="token comment">// what will be exposed</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pgConf <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// coming from env etc</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>transferMoney<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createBankAccounModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>pgConf<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="data-consistency-and-technical-concerns" tabindex="-1"><a class="header-anchor" href="#data-consistency-and-technical-concerns">Data consistency and technical concerns</a></h2>
<p>What happens if one of the balance updates fails and the other does not? We have corrupted data in the database.
In such a command, we want either all writes to be committed or none. This is called atomicity, and it is the A
of <a href="https://en.wikipedia.org/wiki/ACID">ACID</a>.
Luckily for us, our database (postgres) supports atomic transactions. Let’s see how we can modify our database client to
use database transactions.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">CommandFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> db<span class="token operator">:</span> DBClient <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">DBClient</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token generic-function"><span class="token function">query</span><span class="token generic class-name"><span class="token operator">&lt;</span>Row<span class="token operator">></span></span></span><span class="token punctuation">(</span>statement<span class="token operator">:</span> SQLStatement <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>Row<span class="token operator">>></span><span class="token punctuation">;</span>
    <span class="token generic-function"><span class="token function">withinTransaction</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fn <span class="token keyword">extends</span> CommandFn<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>fn<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> fn<span class="token operator">:</span> Fn<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ReturnType<span class="token operator">&lt;</span>Fn<span class="token operator">>></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>The new database client interface has a <code>withinTransaction</code> function that takes a function as input. This function
receives a db client instance as parameter, and the instance will be bound to the current transaction context.
The implementation could be:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span>Pool<span class="token punctuation">,</span> PoolClient<span class="token punctuation">,</span> PoolConfig<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pg'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>SQLStatement<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'sql-template-strings'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> createClient <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> Pick<span class="token operator">&lt;</span>PoolClient<span class="token punctuation">,</span> <span class="token string">'query'</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> db<span class="token operator">:</span> DBClient <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">query</span><span class="token punctuation">(</span>query<span class="token operator">:</span> SQLStatement <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>rows<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">withinTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>fn<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> fn<span class="token operator">:</span> CommandFn <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> db<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createDB <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>pgConf<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> pgConf<span class="token operator">:</span> PoolConfig<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> DBClient <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span>pgConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>client<span class="token operator">:</span> pool<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token function">withinTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>fn<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> fn<span class="token operator">:</span> CommandFn <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'BEGIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token operator">:</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'COMMIT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'ROLLBACK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>The exposed pool wrapper implements the <code>withinTransaction</code> function as a wrapper.
It creates an internal database client dedicated to the transaction, and wraps the execution of the provided <code>fn</code>
function within <code>BEGIN</code>/<code>COMMIT</code> clauses handling errors with <code>ROLLBACK</code>.
The private client wrapper implements the same interface but does nothing with <code>withinTransaction</code>: there is no nested
transaction and calling <code>withinTransaction</code> from inside a running transaction will only pass the
current transaction context.</p>
<p>We can now use database transactions inside our command:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span>createBankAccountRepository<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./bank-account.repository'</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createTransferMoneyCommand</span> <span class="token operator">=</span>
    <span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> DBClient <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">withinTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            fn<span class="token operator">:</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> bankAccountService <span class="token operator">=</span> <span class="token function">createBankAccountRepository</span><span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// atomic updates with default isolation settings</span>
                <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    bankAccountService<span class="token punctuation">.</span><span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        bankAccountId<span class="token operator">:</span> fromAccount<span class="token punctuation">.</span>bankAccountId<span class="token punctuation">,</span>
                        balance<span class="token operator">:</span> newFromBalance<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    bankAccountService<span class="token punctuation">.</span><span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        bankAccountId<span class="token operator">:</span> toAccount<span class="token punctuation">.</span>bankAccountId<span class="token punctuation">,</span>
                        balance<span class="token operator">:</span> newToBalance<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>But this comes at a high cost. We have introduced a strong coupling between the command and the repository: the command has to know the concrete implementation of
<code>BankAccountService</code>, where to import it from, how to instantiate it (class ? factory ? etc.), and depends on the low-level component <code>db</code>.</p>
<p>In a perfect world we want the product engineer to be able to write the business code as he did in the first place, without having to worry about technical details such database transactions and so one.</p>
<h2 id="leverage-the-dependency-injection" tabindex="-1"><a class="header-anchor" href="#leverage-the-dependency-injection">Leverage the dependency injection</a></h2>
<p>The DI container we are using has the nice feature of injecting itself as a dependency in all injectable factories (under the <code>provideSymbol</code> injection token).
We can use this to build a decorator around the command factory to ensure that the command and the entire dependency graph are instantiated within the same database transaction:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// (from now, I remove all the TS noise so example are easier to read)</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>provideSymbol<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dismoi'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> withinTransactionDecorator <span class="token operator">=</span>
    <span class="token comment">// takes a factory ...</span>
    <span class="token punctuation">(</span><span class="token parameter">commandFactory</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token comment">// ... and returns a factory </span>
        <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>db<span class="token punctuation">,</span> <span class="token punctuation">[</span>provideSymbol<span class="token punctuation">]</span><span class="token operator">:</span> provide<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// here db is the pool</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">commandInput</span><span class="token punctuation">)</span> <span class="token operator">=></span> db<span class="token punctuation">.</span><span class="token function">withinTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>db<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                        <span class="token comment">// here db is a client bound to the transaction</span>
                        <span class="token comment">// we can therefore instantiate all the dependency graph at this point</span>
                        <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">{</span>db<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">const</span> command <span class="token operator">=</span> <span class="token function">commandFactory</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// and execute the command</span>
                        <span class="token keyword">return</span> <span class="token function">command</span><span class="token punctuation">(</span>commandInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>You can use the decorator when registering the command to the DI container</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> createModule <span class="token operator">=</span> <span class="token function">createProvider</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    injectables<span class="token operator">:</span> <span class="token punctuation">{</span>
        transferMoney<span class="token operator">:</span> <span class="token function">withinTransactionDecorator</span><span class="token punctuation">(</span>createTransferMoneyCommand<span class="token punctuation">)</span><span class="token punctuation">,</span>
        bankAccountService<span class="token operator">:</span> createBankAccountRepository<span class="token punctuation">,</span>
        db<span class="token operator">:</span> createDB
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    api<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'transferMoney'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>If you look at the <a href="https://opentelemetry.io/docs/concepts/signals/traces/">trace</a>(we will get to this in a future post) of the command execution,
you will see that all the database requests are running in the same transaction:</p>
<figure>
    <img src="/posts/separation-of-concerns/trace-ok.png" alt="trace diagram">
    <figcaption>Trace diagram when command succeeds</figcaption>
</figure>
<p>And if one of the writes happens to fail, the whole transaction is aborted</p>
<figure>
    <img src="/posts/separation-of-concerns/trace-not-ok.png" alt="trace diagram">
    <figcaption>Trace diagram when command fails</figcaption>
</figure>
<p>And that’s it, atomic database transactions are no longer a concern when writing the command: they will be handled automatically in an implicit way.</p>
<h2 id="going-further" tabindex="-1"><a class="header-anchor" href="#going-further">Going further</a></h2>
<p>We can go a little further and build a small framework around the functions we have defined so far.
We want all commands to be atomic by default, so that product engineers are not burdened with these technical details.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createProvider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dismoi'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">defineModule</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commands<span class="token punctuation">,</span> injectables<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    
    <span class="token keyword">const</span> _injectables <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>injectables<span class="token punctuation">,</span>
        <span class="token operator">...</span>_<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>commands<span class="token punctuation">,</span> withinTransactionDecorator<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token function">createProvider</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">injectables</span><span class="token operator">:</span> _injectables<span class="token punctuation">,</span> <span class="token literal-property property">api</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span> 

<span class="token keyword">const</span> createBankAccountModule <span class="token operator">=</span>  <span class="token function">defineModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">commands</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">transferMoney</span><span class="token operator">:</span> createTransferMoneyCommand
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">injectables</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">bankAccountService</span><span class="token operator">:</span> createBankAccountRepository
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>transferMoney<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createBankAccountModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">db</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// db coming from somewhere</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Note: we left the db pool as an external dependency</span>
<span class="token comment">// as it will likely be shared among a set of different modules</span></code></pre>
<p>This API is more explicit about our opinions: we have the notion of commands, DI is more of a detail. On the other hand,
atomicity is guaranteed by default but does not leak into the business code (the command).</p>

</main>
<footer class="wide" id="main-footer">
    <p>© Laurent RENARD. All Rights Reserved.</p>
    <nav aria-labelledby="footer-links">
        <h2 id="footer-links">Author links</h2>
        <ul>
            <li><a href="https://www.linkedin.com/in/laurent-renard-a39b5357">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#linkedin"/>
                </svg>
                linkedin</a></li>
            <li><a href="https://github.com/lorenzofox3">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#github"/>
                </svg>
                Github</a></li>
            <li><a href="https://lorenzofox3.medium.com/">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#medium"/>
                </svg>
                Medium</a></li>
            <li>
                <a href="https://dev.to/lorenzofox3">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#devto"/>
                    </svg>
                    Dev.to</a></li>
            <li><a href="/feed.xml">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#rss"/>
                </svg>
                RSS</a></li>
        </ul>
    </nav>
</footer>
</body>
</html>
