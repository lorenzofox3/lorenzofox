<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Describes how to use a JSON schema to define the API of a software component and improve both the development cycle and the quality of the code.">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="generator" content="Eleventy v2.0.1">
    <title>lorenzofox blog | Schema first design</title>
    <link rel="icon" href="/public/favicon.ico"/>
    <link rel="stylesheet" href="/public/theme.css">
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Blog"/>
    <style>
        #logo {
            aspect-ratio: 1 / 1;
            width: 128px;
        }

        #sprite {
            display: none;
        }
    </style>
</head>
<body>
<svg id="sprite" aria-hidden="true" class="visually-hidden" xmlns="http://www.w3.org/2000/svg">
    <symbol id="devto">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path>
        </svg>
    </symbol>
    <symbol id="github">
        <svg viewBox="0 0 496 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/>
        </svg>
    </symbol>
    <symbol id="medium">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM144.5 319c-35.1 0-63.5-28.4-63.5-63.5s28.4-63.5 63.5-63.5 63.5 28.4 63.5 63.5-28.4 63.5-63.5 63.5zm159 0c-35.1 0-63.5-28.4-63.5-63.5s28.4-63.5 63.5-63.5 63.5 28.4 63.5 63.5-28.4 63.5-63.5 63.5z"/>
        </svg>
    </symbol>
    <symbol id="linkedin">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </symbol>
    <symbol id="rss">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M384 32H64C28.65 32 0 60.66 0 96v320c0 35.34 28.65 64 64 64h320c35.35 0 64-28.66 64-64V96C448 60.66 419.3 32 384 32zM150.6 374.6C144.4 380.9 136.2 384 128 384s-16.38-3.121-22.63-9.371c-12.5-12.5-12.5-32.76 0-45.26C111.6 323.1 119.8 320 128 320s16.38 3.121 22.63 9.371C163.1 341.9 163.1 362.1 150.6 374.6zM249.6 383.9C249 383.1 248.5 384 247.1 384c-12.53 0-23.09-9.75-23.92-22.44C220.5 306.9 173.1 259.5 118.4 255.9c-13.22-.8438-23.25-12.28-22.39-25.5c.8594-13.25 12.41-22.81 25.52-22.38c77.86 5.062 145.3 72.5 150.4 150.4C272.8 371.7 262.8 383.1 249.6 383.9zM345 383.1C344.7 384 344.3 384 343.1 384c-12.8 0-23.42-10.09-23.97-23C315.6 254.6 225.4 164.4 119 159.1C105.8 159.4 95.47 148.3 96.02 135C96.58 121.8 107.9 111.2 121 112c130.7 5.469 241.5 116.3 246.1 246.1C368.5 372.3 358.3 383.4 345 383.1z"/>
        </svg>
    </symbol>
</svg>

<header id="main-header" >
    <nav aria-label="main navigation" class="wide">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a rel="author" href="/about">About</a></li>
        </ul>
    </nav>
    <div class="heading wide">
        <a aria-label="home" href="/"><img id="logo" src="/public/logo.webp" alt="lorenzofox's blog logo"/></a>
        <div class="title">
            <h1>Schema first design</h1>
            
            <p class="publication-date">
                First publication date:
                <time datetime="2025-01-02">Thursday 2 January 2025</time>
            </p>
            
        </div>
    </div>
</header>
<main id="main">
    <div class="intro"> 
<p class="wide">
There are several development methodologies that focus on first defining a contract (or an expected behaviour), for the software component under development: (<a href="https://swagger.io/resources/articles/adopting-an-api-first-approach/">API first design</a>, <a href="https://en.wikipedia.org/wiki/Test-driven_development">test-driven development</a>, etc.). In this article, we will see how using a <a href="https://json-schema.org/">JSON schema</a> to define your API can bring consistency to your software and improve its overall quality.
</p>
</div>
<h2 id="api-schema" tabindex="-1"><a class="header-anchor" href="#api-schema">API schema</a></h2>
<p><a href="https://json-schema.org/">JSON Schema</a> is a popular way of defining data structures. The format can be easily parsed and used to automate the generation of validation logic, test cases, documentation and so on; you will never be short of tools no matter what technology you use.</p>
<p>Taking the example of the <a href="/posts/separation-of-concerns">previous post</a>, let’s see what our API’s schema could be:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>JSONSchema<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'json-schema-to-ts'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    $id<span class="token operator">:</span> <span class="token string">'bank-accounts.schema.json'</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token string">'bank accounts service'</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token string">'The bank accounts service definition'</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
    properties<span class="token operator">:</span> <span class="token punctuation">{</span>
        commands<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
            properties<span class="token operator">:</span> <span class="token punctuation">{</span>
                transferMoney<span class="token operator">:</span> <span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
                    properties<span class="token operator">:</span> <span class="token punctuation">{</span>
                        input<span class="token operator">:</span> <span class="token punctuation">{</span>
                            type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
                            properties<span class="token operator">:</span> <span class="token punctuation">{</span>
                                from<span class="token operator">:</span> <span class="token punctuation">{</span>
                                    $ref<span class="token operator">:</span> <span class="token string">'bank-accounts.schema.json#/definitions/bankAccountId'</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                to<span class="token operator">:</span> <span class="token punctuation">{</span>
                                    $ref<span class="token operator">:</span> <span class="token string">'bank-accounts.schema.json#/definitions/bankAccountId'</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                amount<span class="token operator">:</span> <span class="token punctuation">{</span>
                                    $ref<span class="token operator">:</span> <span class="token string">'bank-accounts.schema.json#/definitions/amount'</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            additionalProperties<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'from'</span><span class="token punctuation">,</span> <span class="token string">'to'</span><span class="token punctuation">,</span> <span class="token string">'amount'</span><span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'input'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    additionalProperties<span class="token operator">:</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'transferMoney'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            additionalProperties<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'commands'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    additionalProperties<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    definitions<span class="token operator">:</span> <span class="token punctuation">{</span>
        bankAccountId<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">'The unique identifier of a bank account'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        amount<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">'A monetary amount, in cents'</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span> satisfies JSONSchema<span class="token punctuation">;</span></code></pre>
<p>I invite you to go through the <a href="https://json-schema.org">JSON schema documentation</a> for more details on the syntax. But, even without that knowledge, you can
understand the overall schema definition with some fields being informative(description, title, etc.) and others being declarative of the data contracts.</p>
<p>The syntax seems a bit verbose, but it brings a lot of flexibility and power as we will soon see. You could anyway avoid some boilerplate by generating the schema on the fly based on a record of command name/command input schema, or use any of your favourite IDE extensions that help with JSON schemas.</p>
<h3 id="runtime-behaviour" tabindex="-1"><a class="header-anchor" href="#runtime-behaviour">Runtime behaviour</a></h3>
<p>Now that we have a definition of the contract, we can easily implement data validation. In the Node.js ecosystem, there are several libraries for building validation on top of JSON schemas, one of the most popular being <a href="https://ajv.js.org/">ajv</a>. Since we want our module contract to be fully defined by the schema, we can modify the <code>defineModule</code> of the framework built in the previous article to enforce this new policy.
The new implementation could be</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createProvider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dismoi'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> assert <span class="token keyword">from</span> <span class="token string">'node:assert'</span>
<span class="token keyword">import</span> Ajv <span class="token keyword">from</span> <span class="token string">'ajv'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">defineModule</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commands<span class="token punctuation">,</span> schema<span class="token punctuation">,</span> injectables<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    ajv<span class="token punctuation">.</span><span class="token function">addSchema</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> commandListFromSchema <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>schema<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>commands<span class="token punctuation">.</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> commandListFromImplementation <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> symmetricDifference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>commandListFromImplementation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">symmetricDifference</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>commandListFromSchema<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>symmetricDifference<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">discrepancy between schema and implementation: [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">[</span><span class="token operator">...</span>symmetricDifference<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> commandWithValidation <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>commands<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">commandFactory<span class="token punctuation">,</span> commandName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> inputSchema <span class="token operator">=</span> schema<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>commands<span class="token punctuation">.</span>properties<span class="token punctuation">[</span>commandName<span class="token punctuation">]</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span>input<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">withValidationDecorator</span><span class="token punctuation">(</span>commandFactory<span class="token punctuation">,</span> inputSchema<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> _injectables <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>injectables<span class="token punctuation">,</span>
        <span class="token operator">...</span>_<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>commandWithValidation<span class="token punctuation">,</span> withinTransactionDecorator<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">createProvider</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">injectables</span><span class="token operator">:</span> _injectables<span class="token punctuation">,</span> <span class="token literal-property property">api</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Now, the function <code>defineModule</code> takes a schema as a parameter. We start by adding the schema to the <code>ajv</code> singleton so that we can reference the main schema in the <code>$ref</code> clauses (in practice, this, should be done slightly differently if you want to be able to reference completely different schemas,e.g. coming from different modules).
We then use the new <code>symmetricDifference</code> of javascript <code>Set</code> to ensure that the schema is consistent with the provided implementation. This is not ideal in the sense that the error is thrown at runtime, but it is not necessarily a problem if you add a simple test to your suite that checks that you can define the module. We will soon see how you can have this signal directly when you code, using Typescript.<br>
What’s left is to map the command input schema and the command factory together with the new <code>withValidationDecorator</code> decorator.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">withValidationDecorator</span><span class="token punctuation">(</span><span class="token parameter">commandFactory<span class="token punctuation">,</span> schema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">deps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> command <span class="token operator">=</span> <span class="token function">commandFactory</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> isValid <span class="token operator">=</span> <span class="token function">validate</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isValid<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid command input'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">cause</span><span class="token operator">:</span> validate<span class="token punctuation">.</span>errors<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">command</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Nothing fancy here. We can then compose with the former <code>withinTransactionDecorator</code> decorator and we now have:</p>
<ol>
<li>Our API fully defined by a json schema</li>
<li>The API can’t change without the schema being updated and vice versa, which somehow enforces keeping the documentation inline with the behaviour.</li>
<li>All our commands run inside a transaction (see previous post)</li>
</ol>
<p>That’s great, but let’s see how we can improve the developer experience even further by using Typescript</p>
<h3 id="developer-experience" tabindex="-1"><a class="header-anchor" href="#developer-experience">Developer experience</a></h3>
<p>In the Javascript ecosystem, <a href="https://www.typescriptlang.org/">Typescript</a>, which brings static typing to Javascript, has also become a popular tool for describing data structures and enforcing their consistency throughout the software stack. However, types disappear at runtime and are less useful when it comes to building runtime logic (i.e. actually validating a data input passed to a function, for example).
For these reasons, developers sometimes tend to duplicate the data structure definition to accommodate different use cases, or rely on libraries that are more specialised and less versatile than a <em>dumb</em> serialisable format like json.</p>
<p>The good news, is that you can use libraries to infer types from a JSON schema. If you paid attention to the schema definition in the introduction, you should have noticed that it <code>satisfies</code> a JSON schema. This gives you auto-completion when you write your schema, and makes sure you don’t have any syntax errors.
We can also use the <code>FromSchema</code> from the same <a href="https://github.com/thomasaribart/json-schema-to-ts">json-schema-to-ts library</a> to infer the definition of the commands.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span>JSONSchema<span class="token punctuation">,</span> FromSchema<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'json-schema-to-ts'</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">CommandsDef<span class="token operator">&lt;</span>Schema <span class="token keyword">extends</span> JSONSchema<span class="token operator">></span></span> <span class="token operator">=</span> FromSchema<span class="token operator">&lt;</span>Schema<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token punctuation">{</span>
    commands<span class="token operator">:</span> <span class="token keyword">infer</span> Commands
<span class="token punctuation">}</span> <span class="token operator">?</span> Commands <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span></code></pre>
<p>In the same way, we can go further and express the command signature (assuming for the moment, that the output is always <code>void</code>):</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">CommandInput<span class="token operator">&lt;</span>Schema <span class="token keyword">extends</span> JSONSchema<span class="token punctuation">,</span> Name <span class="token keyword">extends</span> <span class="token keyword">keyof</span> CommandsDef<span class="token operator">&lt;</span>Schema<span class="token operator">>></span></span> <span class="token operator">=</span> CommandsDef<span class="token operator">&lt;</span>Schema<span class="token operator">></span><span class="token punctuation">[</span>Name<span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token keyword">infer</span> Input
<span class="token punctuation">}</span> <span class="token operator">?</span> Input <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">CommandFn<span class="token operator">&lt;</span>Schema <span class="token keyword">extends</span> JSONSchema<span class="token punctuation">,</span> Name <span class="token keyword">extends</span> <span class="token keyword">keyof</span> CommandsDef<span class="token operator">&lt;</span>Schema<span class="token operator">>></span></span> <span class="token operator">=</span> 
    <span class="token punctuation">(</span>input<span class="token operator">:</span> CommandInput<span class="token operator">&lt;</span>Schema<span class="token punctuation">,</span> Name<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span></code></pre>
<p>As you can see in the animation below, you can now explicitly say that a function is an implementation of the command defined by the schema, and you will get a compilation error if you change either the function signature, or the schema without reflecting the change in a compatible way.</p>
<figure>
    <video controls>
    <source src="/posts/schema-first-design/transfer-money-devx.mp4" />
    </video>
    <figcaption>Dev experience with type inference</figcaption>
</figure>
<p>Again, we can incorporate these new views on how to properly develop an API, directly into the framework.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>ProviderFn<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dismoi'</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">CommandInjectables<span class="token operator">&lt;</span>Schema <span class="token keyword">extends</span> JSONSchema<span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>CommandName <span class="token keyword">in</span> <span class="token keyword">keyof</span> CommandsDef<span class="token operator">&lt;</span>Schema<span class="token operator">></span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span>deps<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> CommandFn<span class="token operator">&lt;</span>Schema<span class="token punctuation">,</span> CommandName<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">defineModule</span><span class="token generic class-name"><span class="token operator">&lt;</span>
    Schema <span class="token keyword">extends</span> JSONSchema<span class="token punctuation">,</span>
    Injectables <span class="token keyword">extends</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span>
<span class="token operator">></span></span></span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token punctuation">{</span>
    schema<span class="token operator">:</span> Schema<span class="token punctuation">;</span>
    commands<span class="token operator">:</span> CommandInjectables<span class="token operator">&lt;</span>Schema<span class="token operator">></span><span class="token punctuation">;</span>
    injectables<span class="token operator">:</span> Injectables
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> ProviderFn<span class="token operator">&lt;</span>Injectables <span class="token operator">&amp;</span> CommandInjectables<span class="token operator">&lt;</span>Schema<span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">keyof</span> CommandInjectables<span class="token operator">&lt;</span>Schema<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></code></pre>
<p>There are now even fewer moving parts:</p>
<ul>
<li>you must include an implementation for each command defined on the schema</li>
<li>you cannot include a command implementation if there is no matching definition on the schema</li>
<li>implementation interfaces must be compatible with the defined API</li>
</ul>
<figure>
    <video controls>
    <source src="/posts/schema-first-design/define-module.mp4" />
    </video>
    <figcaption>Dev experience with type inference on defineModule</figcaption>
</figure>
<h3 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion">Conclusion</a></h3>
<p>The schema has become the centerpiece of our module bringing a strong consistency between the contract and the implementation. Even better, it tailors
the dev experience, forcing the developers to follow team conventions and quality standards (data validation is mandatory, for example).
Yet, we have barely scratched the surface: we could use the schema to automatically generate documentation,a client library, or even test cases. Similarly, we have only used the notion of <em>commands</em>,
but we could also add the API definition output format, error that can be thrown, events that can be raised, etc.</p>

</main>
<footer class="wide" id="main-footer">
    <p>© Laurent RENARD. All Rights Reserved.</p>
    <nav aria-labelledby="footer-links">
        <h2 id="footer-links">Author links</h2>
        <ul>
            <li><a href="https://www.linkedin.com/in/laurent-renard-a39b5357">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#linkedin"/>
                </svg>
                linkedin</a></li>
            <li><a href="https://github.com/lorenzofox3">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#github"/>
                </svg>
                Github</a></li>
            <li><a href="https://lorenzofox3.medium.com/">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#medium"/>
                </svg>
                Medium</a></li>
            <li>
                <a href="https://dev.to/lorenzofox3">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#devto"/>
                    </svg>
                    Dev.to</a></li>
            <li><a href="/feed.xml">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#rss"/>
                </svg>
                RSS</a></li>
        </ul>
    </nav>
</footer>
</body>
</html>
