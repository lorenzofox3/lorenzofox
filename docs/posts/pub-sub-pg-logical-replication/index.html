<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Thoughts on implementing pub/sub with postgres logical replication and Nodejs">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="generator" content="Eleventy v2.0.1">
    <title>lorenzofox blog | Pub/Sub with Postgres logical replication and Nodejs</title>
    <link rel="icon" href="/public/favicon.ico"/>
    <link rel="stylesheet" href="/public/theme.css">
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Blog"/>
    <style>
        #logo {
            aspect-ratio: 1 / 1;
            width: 128px;
        }

        #sprite {
            display: none;
        }
    </style>
</head>
<body>
<svg id="sprite" aria-hidden="true" class="visually-hidden" xmlns="http://www.w3.org/2000/svg">
    <symbol id="devto">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path>
        </svg>
    </symbol>
    <symbol id="github">
        <svg viewBox="0 0 496 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/>
        </svg>
    </symbol>
    <symbol id="medium">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM144.5 319c-35.1 0-63.5-28.4-63.5-63.5s28.4-63.5 63.5-63.5 63.5 28.4 63.5 63.5-28.4 63.5-63.5 63.5zm159 0c-35.1 0-63.5-28.4-63.5-63.5s28.4-63.5 63.5-63.5 63.5 28.4 63.5 63.5-28.4 63.5-63.5 63.5z"/>
        </svg>
    </symbol>
    <symbol id="linkedin">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </symbol>
    <symbol id="rss">
        <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M384 32H64C28.65 32 0 60.66 0 96v320c0 35.34 28.65 64 64 64h320c35.35 0 64-28.66 64-64V96C448 60.66 419.3 32 384 32zM150.6 374.6C144.4 380.9 136.2 384 128 384s-16.38-3.121-22.63-9.371c-12.5-12.5-12.5-32.76 0-45.26C111.6 323.1 119.8 320 128 320s16.38 3.121 22.63 9.371C163.1 341.9 163.1 362.1 150.6 374.6zM249.6 383.9C249 383.1 248.5 384 247.1 384c-12.53 0-23.09-9.75-23.92-22.44C220.5 306.9 173.1 259.5 118.4 255.9c-13.22-.8438-23.25-12.28-22.39-25.5c.8594-13.25 12.41-22.81 25.52-22.38c77.86 5.062 145.3 72.5 150.4 150.4C272.8 371.7 262.8 383.1 249.6 383.9zM345 383.1C344.7 384 344.3 384 343.1 384c-12.8 0-23.42-10.09-23.97-23C315.6 254.6 225.4 164.4 119 159.1C105.8 159.4 95.47 148.3 96.02 135C96.58 121.8 107.9 111.2 121 112c130.7 5.469 241.5 116.3 246.1 246.1C368.5 372.3 358.3 383.4 345 383.1z"/>
        </svg>
    </symbol>
</svg>

<header id="main-header" >
    <nav aria-label="main navigation" class="wide">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a rel="author" href="/about">About</a></li>
        </ul>
    </nav>
    <div class="heading wide">
        <a aria-label="home" href="/"><img id="logo" src="/public/logo.webp" alt="lorenzofox's blog logo"/></a>
        <div class="title">
            <h1>Pub/Sub with Postgres logical replication and Nodejs</h1>
            
            <p class="publication-date">
                First publication date:
                <time datetime="2025-02-10">Monday, 10 February 2025</time>
            </p>
            
        </div>
    </div>
</header>
<main id="main">
    <div class="intro"> 
<p class="wide">
Pub/Sub is a common pattern for distributed - or not - systems. It provides the ability to reduce the coupling between the event producer on one side and the event consumer on the other. We often associate this pattern with event streaming technologies such as Kafka, but this does not have to be the case: Postgres can help you achieve decent scalability, depending on the use case.
</p>
</div>
<h2 id="the-business-case" tabindex="-1"><a class="header-anchor" href="#the-business-case">The business case</a></h2>
<p>You are starting a new business dealing with financial transactions. For some reason (traceability, for example), you
have decided to store all the business facts that happen to the transactions.
Instead of having a <code>transactions</code> table that holds the current state of the transactions, you would rather have a
<code>transaction_events</code> table with all the recorded business events on transactions:</p>
<figure>
<table>
<thead>
<tr>
<th>position</th>
<th>transaction_id</th>
<th>event_type</th>
<th>payload</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>transaction_a</td>
<td>initiated</td>
<td>{ “amount” : 42_00, date: “2025-02-09”}</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>transaction_b</td>
<td>initiated</td>
<td>{ “amount” : 31_00, date: “2025-02-08”}</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>transaction_a</td>
<td>authorized</td>
<td>{ “authority”: “some_bank”}</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>transaction_c</td>
<td>initiated</td>
<td>{ “amount” : 20_00, date: “2025-02-09”}</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>transaction_b</td>
<td>rejected</td>
<td>{  “authority”: “some_bank” }</td>
<td>2</td>
</tr>
</tbody>
</table>
<figcaption> example of transaction event records</figcaption>
</figure>
<ul>
<li><strong>position</strong> is the global position of the event (ie transaction independent)</li>
<li><strong>transaction_id</strong> is a unique identifier of a transaction (which can have more than one event associated)</li>
<li><strong>version</strong> is the transaction version after a specific event has been recorded for that transaction</li>
</ul>
<p>This table is append only. Once an event has been recorded, it can’t be modified: it is the source of truth of all what
happened in your system.</p>
<p>When you look more closely at this table, you realize it is actually a key/value store whose keys are the transaction
ids and the values all the events associated to a specific transaction:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> transactions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">transaction_a</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">'iniated'</span> <span class="token comment">/* .. */</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">'authorized'</span><span class="token punctuation">,</span> <span class="token comment">/* .. */</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">transaction_b</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">'iniated'</span> <span class="token comment">/* .. */</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">'rejected'</span><span class="token punctuation">,</span> <span class="token comment">/* .. */</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">transaction_c</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">'iniated'</span> <span class="token comment">/* .. */</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So that, at any time, by reducing the events, you are able to define the current state of a given transaction:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> transactionA <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">transactionId</span><span class="token operator">:</span> <span class="token string">'transaction_a'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'authorized'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">amount</span><span class="token operator">:</span> <span class="token number">42_00</span><span class="token punctuation">,</span>
    <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token string">'2025-02-09'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">authority</span><span class="token operator">:</span> <span class="token string">'some_bank'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span></code></pre>
<p>This is fine for the first few months and for most use cases. But as the business becomes more successful, it becomes
more complicated to answer questions such as <em>&quot;What are all the transactions authorised by authority “Bank A”?</em> The
key/value store starts to show its limitations</p>
<p>This is not necessarily a big deal: you can build a <em>read model</em> designed for this specific use case:</p>
<figure>
<table>
<thead>
<tr>
<th>transaction_id</th>
<th>status</th>
<th>amount</th>
<th>date</th>
<th>authority</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<td>transaction_a</td>
<td>authorized</td>
<td>42_00</td>
<td>2025-02-09</td>
<td>some_bank</td>
<td>2</td>
</tr>
<tr>
<td>transaction_b</td>
<td>rejected</td>
<td>31_00</td>
<td>2025-02-08</td>
<td>some_bank</td>
<td>2</td>
</tr>
<tr>
<td>transaction_c</td>
<td>initiated</td>
<td>10_00</td>
<td>2025-02-09</td>
<td>null</td>
<td>1</td>
</tr>
</tbody>
</table>
<figcaption> Read model table for transactions</figcaption>
</figure>
<p>With the right indexing strategy, it will give you acceptable performance for most of the questions you can ask about
the current state of transactions.
Of course, you have to maintain this read model, but because we are using Postgres, we can perform any write operation
on this model within the same database transaction that produces the event, which guarantees strong consistency.</p>
<p>A few months go by, and again you have new requirements: not only do you have to maintain the read model, but every time
a transaction is initiated, you have to trigger a background job for fraud detection. You also need to maintain a
consolidated analytics view, etc.
You understand: you cannot cram all this logic into the same database transaction and you need to decouple all this
processing.</p>
<h2 id="postgres-logical-replication" tabindex="-1"><a class="header-anchor" href="#postgres-logical-replication">Postgres logical replication</a></h2>
<p>You have decided that decoupling the publication of the event from its processing is the way to go and have started
looking at various pub/sub systems (Kafka, RabbitMQ, Google pub/sub, etc.).
You are a little puzzled by the challenges of running these systems, especially as you do not have the skills in-house.
Fear not, you can simply
use <a href="https://www.postgresql.org/docs/current/logical-replication.html">Postgres logical replication</a>.</p>
<p>This is a built-in mechanism that works by publishing the logical operations that take place in the database. In our
case, this could be notification whenever a new row is appended to the <code>transactions_events</code> table.
It relies on <a href="https://www.postgresql.org/docs/current/wal-intro.html">Write-Ahead logging</a>, a standard method of
ensuring data integrity. It consists in writing data changes to a log before flushing the new data pages to disk and
reducing the disk accesses. In the event of a failure,
the system only needs to replay these logical operations to recover the current state of the database.</p>
<p>The WAL is an ephemeral structure that disappears when all subscriptions to a given publication have confirmed that they
have received the messages. This is not a problem in the sense that it means that the data has been safely persisted to
the various tables and consumed by the subscribers.</p>
<p>Without going into too much detail, we need to change the Postgres configuration to allow logical replication:</p>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># pg.conf</span>
wal_level <span class="token operator">=</span> logical</code></pre>
<p>and create a publication for the relevant table:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> PUBLICATION test_publication <span class="token keyword">FOR</span> <span class="token keyword">TABLE</span> ONLY transaction_events <span class="token keyword">WITH</span> <span class="token punctuation">(</span>publish <span class="token operator">=</span><span class="token string">'insert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>You can now subscribe to the insertion of rows into the <code>transaction_events</code> table.</p>
<p>Code-wise, there is nothing else to do on the publishing side, and we have a system with the following properties:</p>
<ul>
<li><strong>Persistence</strong> and <strong>Durability</strong>: as the source of the events is a regular table, we have the same guarantees of
data integrity that Postgres provides.</li>
<li><strong>Message ordering</strong>: the WAL records all the transactions as they are committed, so that the column <code>position</code>
gives us global ordering.</li>
<li><strong>Message delivery guarantees</strong>: by design, we have the guarantee that a message will be delivered at least once (
that’s sort of the purpose of the WAL), and messages are kept in the WAL until subscribers have acknowledged receipt
of the messages (this can lead to WAL file bloat if you don’t handle subscription lifecycles properly).</li>
<li>Regarding the performances (<strong>throughput</strong> and <strong>latency</strong>) we are going to conduct some experiments, but the TLDR; is
that the system is quite sufficient for the expected OLTP load of our platform.</li>
</ul>
<h2 id="subscribing-to-new-events" tabindex="-1"><a class="header-anchor" href="#subscribing-to-new-events">Subscribing to new events</a></h2>
<p>To subscribe to a publication, we have to either create a subscription (mostly used for replication between different
databases) or manually manage a replication slot:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> pg_create_logical_replication_slot<span class="token punctuation">(</span><span class="token string">'test_slot'</span><span class="token punctuation">,</span> <span class="token string">'pgoutput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- pgoutput is the plugin to decode the messages</span></code></pre>
<p>Once the slot is created, we should connect a client that handles
the <a href="https://www.postgresql.org/docs/current/protocol-logical-replication.html">logical streaming replication protocol</a>
to the database server, and decode the messages as they arrive in order to process them.</p>
<p>We will be using an <a href="https://www.npmjs.com/package/pg-logical-replication">existing library</a> for that and wrap it so we
can provide a streaming API:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>Readable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'node:stream'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
    LogicalReplicationService<span class="token punctuation">,</span>
    PgoutputPlugin<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pg-logical-replication'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LogicalReplicationStream</span> <span class="token keyword">extends</span> <span class="token class-name">Readable</span> <span class="token punctuation">{</span>
    #source<span class="token punctuation">;</span>
    #lastLsn<span class="token punctuation">;</span>
    #decoder<span class="token punctuation">;</span>
    #slotName<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
            highWaterMark <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
            publicationName<span class="token punctuation">,</span>
            clientConfig<span class="token punctuation">,</span>
            slotName<span class="token punctuation">,</span>
            onError <span class="token operator">=</span> console<span class="token punctuation">.</span>error<span class="token punctuation">,</span>
        <span class="token punctuation">}</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>highWaterMark<span class="token punctuation">,</span> <span class="token literal-property property">objectMode</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> replicationService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogicalReplicationService</span><span class="token punctuation">(</span>
            clientConfig<span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">acknowledge</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">auto</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">timeoutSeconds</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>#slotName <span class="token operator">=</span> slotName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>#decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PgoutputPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">protoVersion</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token literal-property property">binary</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">publicationNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>publicationName<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>#source<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">lsn<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>lsn<span class="token punctuation">,</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> replicationService<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>lsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>#source<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>#source<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'heartbeat'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">lsn<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> shouldRespond</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRespond<span class="token punctuation">)</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>lsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#source<span class="token punctuation">.</span><span class="token function">isStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>#source<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#decoder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#slotName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#lastLsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token parameter">lsn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#lastLsn <span class="token operator">=</span> lsn<span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#source<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>lsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>It is a Readable stream we set in object mode. The underlying source is a logical replication service provided by the
aforementioned library.
We set up the different listeners: whenever the underlying source sends a new message, we push it into the internal
stream buffer. We then acknowledge the reception of the message.
It the internal queue is full, we need to handle backpressure (if <code>this.push(data)</code> returns false) by pausing the
subscription until the consumer can handle more data, and the <code>_read</code> function is called again.</p>
<aside>
Note that at this point we have no guarantee that the message has actually been consumed downstream (it's just in the internal queue of the stream), and if the process crashes we might lose some messages. It is not a big deal if we instrument the code properly (in terms of observability): in this case we could just replay the missing events directly from the transaction events source.
Alternatively, we could put the onus of recognition on the consumer.
</aside>
<p>Now we have the possibility to read the event stream:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogicalReplicationStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  subscriptionName<span class="token punctuation">,</span>
  <span class="token literal-property property">publicationName</span><span class="token operator">:</span> <span class="token string">'test_publication'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">slotName</span><span class="token operator">:</span> <span class="token string">'test_slot'</span><span class="token punctuation">,</span>
  clientConfig<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> message <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Whenever a new event is appended to the table, this program will output</p>
<pre class="language-text"><code class="language-text">{
  lsn: '0/1916E98',
  message: {
    tag: 'begin',
    commitLsn: '00000000/01916FE0',
    commitTime: 1740934214433862n,
    xid: 752
  }
}

{
  lsn: '0/1916E98',
  message: {
    tag: 'insert',
    relation: {
      tag: 'relation',
      relationOid: 16386,
      schema: 'public',
      name: 'transaction_events',
      replicaIdentity: 'default',
      columns: [Array],
      keyColumns: [Array]
    },
    new: [Object: null prototype] {
      position: '10',
      event_type: 'initiated',
      transaction_id: 'R5rReE9dHkvQo8RSqJxX1',
      payload: [Object],
      version: 1,
      created_at: 2025-03-02T16:50:14.433Z
    }
  }

{
  lsn: '0/1917010',
  message: {
    tag: 'commit',
    flags: 0,
    commitLsn: '00000000/01916FE0',
    commitEndLsn: '00000000/01917010',
    commitTime: 1740934214433862n
  }
}
</code></pre>
<p>The triplet covers the whole database operation: the actual database insert (in the middle), together with the transaction <em>begin</em> and <em>commit</em> phases. Each message has its own <strong>lsn</strong> (<a href="https://www.postgresql.org/docs/current/datatype-pg-lsn.html">log sequence number</a>), but you can see the set as a whole.</p>
<p>As we have a stream API, it is fairly easy to filter, group, map, etc. messages with async generators for example. We can for example group all the events recorded in the same database transaction into a single message and wrap our subscription:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createSubscription</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
                                     subscriptionName<span class="token punctuation">,</span>
                                     clientConfig<span class="token punctuation">,</span>
                                     handler<span class="token punctuation">,</span>
                                   <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogicalReplicationStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    subscriptionName<span class="token punctuation">,</span>
    <span class="token literal-property property">publicationName</span><span class="token operator">:</span> <span class="token string">'test_publication'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">slotName</span><span class="token operator">:</span> <span class="token string">'test_slot'</span><span class="token punctuation">,</span>
    clientConfig<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> transaction <span class="token keyword">of</span> <span class="token function">groupByTransaction</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> transaction <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">await</span> stream<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span>commitEndLsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">groupByTransaction</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentTransaction <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'begin'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentTransaction <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">commitLsn</span><span class="token operator">:</span> message<span class="token punctuation">.</span>commitLsn<span class="token punctuation">,</span>
        <span class="token literal-property property">events</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">xid</span><span class="token operator">:</span> message<span class="token punctuation">.</span>xid<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'insert'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentTransaction<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'commit'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> replicationLagMs <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">Number</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>commitTime <span class="token operator">/</span> <span class="token number">1000n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentTransaction<span class="token punctuation">.</span>commitEndLsn <span class="token operator">=</span> message<span class="token punctuation">.</span>commitEndLsn<span class="token punctuation">;</span>
      currentTransaction<span class="token punctuation">.</span>replicationLagMs <span class="token operator">=</span> replicationLagMs<span class="token punctuation">;</span>
      <span class="token keyword">yield</span> currentTransaction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This can be helpful if you want to handle in a different way, a database transaction with many events (probably related to data ingestion), and a database operation with only a handful of events.</p>
<p>By design, the WAL doesn’t generate nested database transaction messages. You may also notice that the message is now only acknowledged if it has been processed by the subscriber.</p>
<h2 id="load-test" tabindex="-1"><a class="header-anchor" href="#load-test">Load test</a></h2>
<p>In the future, we assume an <a href="https://en.wikipedia.org/wiki/Online_transaction_processing">OLTP</a> load (small short database transactions) of a few hundred messages by second. Let’s see how our system will cope with this load, by tracking the lag time between the event production and the time the read model is updated.</p>
<p>Our subscriber can be:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> opentelemetry<span class="token punctuation">,</span> <span class="token punctuation">{</span> ValueType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@opentelemetry/api'</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">const</span> subscriptionMeter <span class="token operator">=</span> opentelemetry<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span><span class="token function">getMeter</span><span class="token punctuation">(</span><span class="token string">'subscription'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// we create a metric for the lag</span>
<span class="token keyword">const</span> lag <span class="token operator">=</span> subscriptionMeter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'subscription.events.lag'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">description</span><span class="token operator">:</span>
    <span class="token string">'duration between the commit time of a transaction and the processing by the subscription'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">unit</span><span class="token operator">:</span> <span class="token string">'ms'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">valueType</span><span class="token operator">:</span> ValueType<span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token function">createSubscription</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">subscriptionName</span><span class="token operator">:</span> <span class="token string">'test_slot'</span><span class="token punctuation">,</span>
  clientConfig<span class="token punctuation">,</span>
  <span class="token literal-property property">handler</span><span class="token operator">:</span> transactionHandler<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> subscription<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transactionHandler</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">transaction</span><span class="token operator">:</span> dbTransaction <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> events <span class="token punctuation">}</span> <span class="token operator">=</span> dbTransaction<span class="token punctuation">;</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    events<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">transaction_id</span><span class="token operator">:</span> transactionId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transactionId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">saveReadTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transaction<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update the metric</span>
  lag<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>dbTransaction<span class="token punctuation">.</span>replicationLagMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>where <code>getTransaction</code> would be a function to read all events associated with a given <code>transaction_id</code> from the event store and fold them into the current transaction state.</p>
<p><code>saveReadTransaction</code> would be:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">saveReadTransaction</span> <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> transaction <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                  <span class="token keyword">const</span> <span class="token punctuation">{</span>
                    transactionId<span class="token punctuation">,</span>
                    status<span class="token punctuation">,</span>
                    version<span class="token punctuation">,</span>
                    date<span class="token punctuation">,</span>
                    authority <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                    amount<span class="token punctuation">,</span>
                  <span class="token punctuation">}</span> <span class="token operator">=</span> transaction<span class="token punctuation">;</span>
                  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token constant">SQL</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
MERGE INTO transactions t
USING (VALUES (
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>transactionId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">::integer, 
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>authority<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>date<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">::timestamp, 
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">::float)) AS source(transaction_id, status, version, authority, date, amount)
ON source.transaction_id = t.transaction_id
WHEN MATCHED AND source.version > t.version THEN
    UPDATE SET
        version = source.version,
        status = source.status,
        authority = source.authority,
        date = source.date,
        amount = source.amount
WHEN NOT MATCHED THEN
    INSERT (transaction_id, status, version, authority, date, amount)
    VALUES (source.transaction_id, source.status, source.version, source.authority, source.date, source.amount)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>A merge query that creates a new row in the read model if there is none for the given <code>transaction_id</code>, or updates the existing one if we have a newer version.
Of course we could have written the same logic in Javascript but I find the SQL merge solution quite appropriate for such use cases.</p>
<p>It is important to note that by first retrieving the transaction from the event store and then using a SQL merge query, our subscription handler is <strong>idempotent</strong>.
This gives us more robustness when it comes to replaying events (remember, we have <em>at least once</em> delivery guarantee) or if we have missed an event for some reason.</p>
<p>On the publisher side we will simply insert a new event (corresponding to the initialisation of a new transaction) at most every 10ms, during 20 minutes, and track the number of events inserted:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> signal <span class="token operator">=</span> AbortSignal<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1_000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>clientConfig<span class="token punctuation">,</span>
  signal<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eventStore <span class="token operator">=</span> <span class="token function">createEventStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span> db <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> eventStore<span class="token punctuation">.</span><span class="token function">appendEvent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">events</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'initiated'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transactionId</span><span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">payload</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">amount</span><span class="token operator">:</span> faker<span class="token punctuation">.</span>finance<span class="token punctuation">.</span><span class="token function">amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">date</span><span class="token operator">:</span> faker<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">recent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  eventCounter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Let’s have a look at the telemetry results:</p>
<figure>
    <img src="/posts/pub-sub-pg-logical-replication/volume.png" alt="volume of events processed over time">
    <figcaption>Events volume</figcaption>
</figure>
<p>The system was able to ingest around 135k events with a steady ingestion rate. We don’t see any gap between publication and subscription.</p>
<figure>
    <img src="/posts/pub-sub-pg-logical-replication/replication-lag.png" alt="replication lag">
    <figcaption>subscription latency</figcaption>
</figure>
<p>With a p99 of 20ms at most, we can consider the data in the read model to be consistent with the source of truth (the event store): when an event is created, the read model is up to date at most 20ms after ingestion.
The replication does not lag behind the production of the events and the WAL can be purged by Postgres on a regular basis avoiding any file bloat.</p>
<p>This is obviously a simulation with some caveats:</p>
<ul>
<li>we only have one subscription</li>
<li>we have not simulated spikes in the load</li>
<li>we only consider the “initialisation” event</li>
<li>there is no concurrency</li>
</ul>
<p>On the other hand, the database is running in a Docker container on an old machine (MacBook Pro early 2015 - 2.7 GHz Dual-Core Intel Core i5 - 8 GB RAM) and could easily handle the expected load without any special tuning.</p>
<p>This means that before Postgres becomes the bottleneck of the system, the business will probably be quite profitable and we should be able to hire a better architect than me :)!</p>
<p>If you wish to run your own simulations you can use <a href="">this repository</a> as base project</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion">Conclusion</a></h2>
<p>Postgres (and NodeJS) once again proved to be a versatile tool, allowing us to implement a robust pub/sub system with very little effort (none on the publishing side!).
We have set up the basics of a protocol to see if this can be scaled up sufficiently.
However, we have not delved too deeply into the details and could follow up with some investigations in further posts. For example, we could see how to safely perform the first synchronisation between the event store and a new reading model, since the WAL will only produce record up to a certain point in time.</p>

</main>
<footer class="wide" id="main-footer">
    <p>© Laurent RENARD. All Rights Reserved.</p>
    <nav aria-labelledby="footer-links">
        <h2 id="footer-links">Author links</h2>
        <ul>
            <li><a href="https://www.linkedin.com/in/laurent-renard-a39b5357">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#linkedin"/>
                </svg>
                linkedin</a></li>
            <li><a href="https://github.com/lorenzofox3">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#github"/>
                </svg>
                Github</a></li>
            <li><a href="https://lorenzofox3.medium.com/">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#medium"/>
                </svg>
                Medium</a></li>
            <li>
                <a href="https://dev.to/lorenzofox3">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#devto"/>
                    </svg>
                    Dev.to</a></li>
            <li><a href="/feed.xml">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#rss"/>
                </svg>
                RSS</a></li>
        </ul>
    </nav>
</footer>
</body>
</html>
